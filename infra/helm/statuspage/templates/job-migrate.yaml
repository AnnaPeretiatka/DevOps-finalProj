{{- if .Values.migrations.enabled }}
apiVersion: batch/v1
kind: Job
metadata: {
  name: statuspage-migrate-{{ now | date "20060102150405" }},
  namespace: statuspage
}
spec:
  ttlSecondsAfterFinished: 3600
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: migrate
          image: "{{ required "image.repository is required" .Values.image.repository }}:{{ .Values.image.tag }}"
          command: ["python","statuspage/manage.py","migrate","--noinput"]
          envFrom: [{ secretRef: { name: statuspage-secrets }}, { configMapRef: { name: statuspage-config }}]
{{- end }}
